<!--#include file="inc-header2.html"-->
<div class="middle" id="middle">
  <div class="page-wrapper">
    <div class="container">
      <div class="accept">
        <div class="ui-title">Родительские собрания в общеобразовательных школах, дошкольных учреждениях</div>
        <form action="" class="accept-form">
          <div class="row">
            <div class="col-md-4 col-sm-6">
              <div class="white-block">
                <div class="accept-file" data-name="file1">
                  <div class="accept-file-title">Добавить файл</div>
                  <div class="accept-file-subtitle">1 фото, 1 видео</div>
                  <div class="accept-file-list empty">
                    <img src="./images/icon-files.svg" class="icon" alt="">
                  </div>
                </div>
                <div class="ui-fields">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Какое-то текстовое поле:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="text1"
                          id="text1"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Что-то числовое:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="number1"
                          id="number1"
                          data-validation="number"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Какое-то текстовое поле:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="text2"
                          id="text2"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div class="ui-label">
                          Какой-то селект
                        </div>
                        <select
                          type="text"
                          class="ui-input ui-select small"
                          name="select1"
                          id="select1"
                          required
                        >
                          <option></option>
                          <option value="1">1</option>
                          <option value="0">0</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div class="ui-label">Выбор даты:</div>
                        <span class="calendar">
                          <img src="./images/icon-date.svg" alt="">
                          <input
                            type="text"
                            class="ui-input small calendar"
                            placeholder="__.__.____"
                            id="date"
                            name="date"
                          >
                        </span>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div class="ui-label">
                          Какой-то мультиселект
                        </div>
                        <select class="js-example-basic-multiple" name="options[]" multiple="multiple">
                          <option value="1">Option1</option>
                          <option value="2">Option2</option>
                          <option value="3">Option3</option>
                          <option value="4">Option4</option>
                          <option value="5">Option5</option>
                          <option value="6">Option6</option>
                          <option value="7">Option7</option>
                          <option value="8">Option8</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <label class="ui-checkbox-label">
                    <input type="checkbox" class="ui-checkbox">
                    Да/Нет
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-4 col-sm-6">
              <div class="white-block">
                <div class="accept-file" data-name="file2">
                  <div class="accept-file-title">Добавить файл</div>
                  <div class="accept-file-subtitle">1 фото, 1 видео</div>
                  <div class="accept-file-list empty">
                    <img src="./images/icon-files.svg" class="icon" alt="">
                  </div>
                </div>
                <div class="ui-fields">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Какое-то текстовое поле:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="text3"
                          id="text3"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Что-то числовое:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="number2"
                          id="number2"
                          data-validation="number"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Какое-то текстовое поле:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="text4"
                          id="text4"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div class="ui-label">
                          Какой-то селект
                        </div>
                        <select
                          type="text"
                          class="ui-input ui-select small"
                          name="select2"
                          id="select2"
                          required
                        >
                          <option></option>
                          <option value="1">1</option>
                          <option value="0">0</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 col-sm-6">
              <div class="white-block">
                <div class="accept-file" data-name="file3">
                  <div class="accept-file-title">Добавить файл</div>
                  <div class="accept-file-subtitle">1 фото, 1 видео</div>
                  <div class="accept-file-list empty">
                    <img src="./images/icon-files.svg" class="icon" alt="">
                  </div>
                </div>
                <div class="ui-fields">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Какое-то текстовое поле:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="text5"
                          id="text5"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Что-то числовое:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="number3"
                          id="number3"
                          data-validation="number"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div for="login" class="ui-label">Какое-то текстовое поле:</div>
                        <input
                          type="text"
                          class="ui-input"
                          name="text6"
                          id="text6"
                          required
                        >
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="ui-field">
                        <div class="ui-label">
                          Какой-то селект
                        </div>
                        <select
                          type="text"
                          class="ui-input ui-select small"
                          name="select3"
                          id="select3"
                          required
                        >
                          <option></option>
                          <option value="1">1</option>
                          <option value="0">0</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="ui-btns">
            <a href="#" class="ui-btn blue">
              <img src="./images/icon-back.svg" alt="">
              Назад
            </a>
            <button class="ui-btn submit">Подтвердить выполнение</button>
          </div>
        </form>
        <script>
          document.addEventListener("DOMContentLoaded", (event) => {
            $(document).ready(function () {
              const popup = $('.accept-popup-bg')
              let indexDeleteFile = []
              let arrFiles = []
              let imageCount = 0;
              let videoCount = 0;
              let otherCount = 0;

              // массив для сохранения файлов
              // let savedFiles = []
              let savedFiles = {}
              $('.accept-file').each(function() {
                const name = $(this).data('name');
                savedFiles[name] = [];
              });

              // загрузка файлов
              $('.accept-popup-upload input[type=file]').on('change', function(event) {
                const inputFiles = Array.from(event.target.files);
                const currentBlock = $('.accept-file.open');
                const fieldName = currentBlock.attr('data-name')

                if (inputFiles && inputFiles.length) {
                  const parent = $(this).closest('.accept-popup');

                  inputFiles.forEach((file, index) => {
                    // Проверка размера файла (5 MB)
                    if (file.size > 40 * 1024 * 1024) {
                      alert(`Файл "${file.name}" превышает максимальный размер в 5 Мб и не будет загружен.`);
                      return
                    }

                    const fileURL = URL.createObjectURL(file);
                    let fileItem

                    if(file.type.match("image")) {
                      fileItem = `<div class="accept-popup-item">
                        <span class="label">${file.name}</span>
                        <img src="${fileURL}" class="preview" alt="">
                        <div class="delete-file"></div>
                      </div>`;
                    } else if(file.type.match("video")) {
                      fileItem = `<div class="accept-popup-item">
                        <span class="label">${file.name}</span>
                        <video src="${fileURL}" class="preview" alt=""></video>
                        <div class="delete-file"></div>
                      </div>`;
                    } else {
                      fileItem = `<a class="accept-popup-item doc" href="${fileURL}" download>
                      <span class="label">${file.name}</span>
                      <div class="delete-file"></div>
                      </a>`;
                    }

                    parent.find('.accept-popup-files').append(fileItem);
                    parent.find('.accept-popup-block').removeClass('empty');
                    parent.find('.accept-popup-bottom').removeClass('empty');

                    arrFiles.push(file)
                  });

                  console.log('загрузка')
                  console.log(arrFiles)
                  console.log(savedFiles)
                }
              });

              // открыть попап
              $('.accept-file').on('click', function(event) {
                const popupParent = popup.find('.accept-popup');
                const input = popup.find('.accept-popup-input')
                const listFilesElements = popup.find('.accept-popup-block')

                const currentBlock = $(this).closest('.accept-file');
                const fieldName = currentBlock.attr('data-name')

                input.val('')

                arrFiles = []
                imageCount = 0
                videoCount = 0
                otherCount = 0

                $(this).closest('.accept-file').addClass('open')
                listFilesElements.find('.accept-popup-item').remove()

                if(savedFiles[fieldName] && savedFiles[fieldName].length) {
                  savedFiles[fieldName].forEach(function(file) {
                    const fileURL = URL.createObjectURL(file);
                    let fileItem

                    if(file.type.match("image")) {
                      fileItem = `<div class="accept-popup-item">
                        <span class="label">${file.name}</span>
                        <img src="${fileURL}" class="preview" alt="Preview">
                        <div class="delete-file"></div>
                      </div>`;
                    } else if(file.type.match("video")) {
                      fileItem = `<div class="accept-popup-item">
                        <span class="label">${file.name}</span>
                        <video src="${fileURL}" class="preview" alt="Preview"></video>
                        <div class="delete-file"></div>
                      </div>`;
                    } else {
                      fileItem = `<a class="accept-popup-item doc" href="${fileURL}" download>
                      <span class="label">${file.name}</span>
                      <div class="delete-file"></div>
                      </a>`;
                    }

                    popupParent.find('.accept-popup-files').append(fileItem);
                  })

                  arrFiles = [...savedFiles[fieldName]]

                  popupParent.find('.accept-popup-block').removeClass('empty');
                  popupParent.find('.accept-popup-bottom').removeClass('empty');
                } else {
                  popupParent.find('.accept-popup-block').addClass('empty');
                  popupParent.find('.accept-popup-bottom').addClass('empty');
                }

                popup.removeClass('hidden')
                $('body').css('overflow', 'hidden');

                console.log('открытие')
                console.log(arrFiles)
                console.log(savedFiles)
              });

              // сохранить изменения
              $('.ui-btn.save').on('click', function() {
                const filesToDelete = popup.find('.accept-popup-item.remove')
                const currentBlock = $('.accept-file.open')
                const fieldName = currentBlock.attr('data-name')
                const fileListBlock = currentBlock.find('.accept-file-list')
                const info = currentBlock.find('.accept-file-subtitle')
                const title = currentBlock.find('.accept-file-title')

                // файлы на удаление
                filesToDelete.each(function() {
                  $(this).remove()
                })

                indexDeleteFile.sort((a, b) => b - a);
                indexDeleteFile.forEach(index => {
                  arrFiles.splice(index, 1);
                });

                // закрытие попапа
                currentBlock.removeClass('open');
                popup.addClass('hidden');
                $('body').css('overflow', '');

                // if(savedFiles.length === 0) return

                // сохранение загруженных файлов
                fileListBlock.find('.accept-file-item').remove()
                savedFiles[fieldName] = arrFiles

                if(savedFiles[fieldName].length) {
                  const totalFiles = savedFiles[fieldName].length;

                  // Отображение блоками по 5 элементов
                  for (let i = 0; i < totalFiles; i++) {
                    const file = savedFiles[fieldName][i];
                    const fileURL = URL.createObjectURL(file);
                    let fileItem;

                    if (file.type.match("image")) {
                      imageCount++;
                      if (i < 5) {
                        fileItem = `<div class="accept-file-item">
                        <img src="${fileURL}" class="preview" alt="Preview">
                        </div>`;
                      }
                    } else if (file.type.match("video")) {
                      videoCount++;
                      if (i < 5) {
                        fileItem = `<div class="accept-file-item">
                        <video src="${fileURL}" class="preview" alt="Preview"></video>
                        </div>`;
                      }
                    } else {
                      otherCount++;
                      if (i < 5) {
                        // fileItem = `<a href="${fileURL}" class="accept-file-item doc"></a>`;
                        fileItem = `<div class="accept-file-item doc"></div>`;
                      }
                    }

                    // Добавляем элемент в блок только если он определён
                    if (fileItem && i < 5) {
                      fileListBlock.append(fileItem);
                    }
                  }

                  // Если загружено больше 5 файлов, отобразим количество оставшихся
                  if (totalFiles > 5) {
                    const remainingFiles = totalFiles - 5;
                    fileListBlock.append(`<div class="accept-file-item count">+${remainingFiles}</div>`);
                  }

                  fileListBlock.removeClass('empty');
                  title.text('просмотреть файлы')
                } else {
                  fileListBlock.addClass('empty');
                  title.text('Добавить файл')
                }

                indexDeleteFile = []
                info.text(`${imageCount} фото, ${videoCount} видео, ${otherCount} документ`)

                console.log('сохранение')
                console.log(arrFiles)
                console.log(savedFiles)
              });

              // отменить изменения
              $('.accept-popup-close, .ui-btn.close').on('click', function() {
                const filesToDelete = popup.find('.accept-popup-item')
                const currentBlock = $('.accept-file.open')

                indexDeleteFile = [];

                filesToDelete.removeClass('remove');
                currentBlock.removeClass('open');
                popup.addClass('hidden');
                $('body').css('overflow', '');
              });

              // удаление файла
              $('.accept-popup-files').on('click', '.accept-popup-item', function(event) {
                if ($(event.target).closest('.delete-file').length) {
                  event.stopPropagation();
                  event.preventDefault();

                  const item = $(this);
                  const parent = item.closest('.accept-popup');

                  item.addClass('remove');
                  indexDeleteFile.push(item.index());

                  // Проверяем, если все дочерние элементы имеют класс remove
                  if (parent.find('.accept-popup-files').children().length === parent.find('.accept-popup-files').children('.remove').length) {
                    parent.find('.accept-popup-block').addClass('empty');
                  }
                }
              });

              // валидация поле для блока с файлами
              $('.accept-popup-close, .ui-btn.close, .ui-btn.submit, .ui-btn.save').on('click', function() {
                const arr = Object.values(savedFiles);

                $('.accept-file').removeClass('error');
                arr.forEach((filesArray, index) => {
                  if (Array.isArray(filesArray)) {
                    const block = $(`.accept-file[data-name=file${index + 1}]`);

                    if (filesArray.length === 0) {
                      block.addClass('error');
                    } else {
                      block.removeClass('error');
                    }
                  }
                });
              });


              // валидация
              $(".accept-form").validate({
                errorElement: "span",

                // rules: {
                //   text1: {
                //     required: true,
                //     // lettersonly: true,
                //   },
                //   text2: {
                //     required: true,
                //     // lettersonly: true,
                //   },
                //   text3: {
                //     required: true,
                //     // lettersonly: true,
                //   },
                //   text4: {
                //     required: true,
                //     // lettersonly: true,
                //   },
                //   text5: {
                //     required: true,
                //     // lettersonly: true,
                //   },
                //   text6: {
                //     required: true,
                //     // lettersonly: true,
                //   },

                //   number1: {
                //     required: true,
                //     number: true
                //   },
                //   number2: {
                //     required: true,
                //     number: true
                //   },
                //   number3: {
                //     required: true,
                //     number: true
                //   },

                //   select1: {
                //     required: true,
                //   },
                //   select2: {
                //     required: true,
                //   },
                //   select3: {
                //     required: true,
                //   },
                // },

                errorPlacement: function (error, element) {
                  if (element.hasClass('ui-select')) {
                    element.closest('.ui-field').append(error);
                  }
                  if (element.hasClass('ui-input')) {
                    element.closest('.ui-field').append(error);
                  }
                },

                submitHandler: function(form, event) {
                  event.preventDefault();
                  const data = new FormData();
                  let hasError = false;

                  $('.accept-file').removeClass('error');

                  for (const key in savedFiles) {
                    const filesArray = savedFiles[key];
                    const block = $(`.accept-file[data-name=${key}]`);


                    if (Array.isArray(filesArray) && filesArray.length === 0) {
                      block.addClass('error');
                      hasError = true;
                    } else {
                      filesArray.forEach((file, index) => {
                        console.log(key)
                        data.append(`${key}`, file);
                      });

                      block.removeClass('error');
                    }
                  }

                  if (hasError) {
                    return;
                  } else {
                    form.submit()
                  }
                }
              });


              $("input[data-validation]").each(function() {
                var validationTypes = $(this).data("validation");

                if(validationTypes === 'number') {
                  $(this).rules('add', {
                    number: true
                  });
                }
              });
            });
          });
        </script>
        <div class="accept-popup-bg hidden">
          <div class="accept-popup">
            <div class="accept-popup-header">
              <div class="accept-popup-title">Добавить файлы</div>
              <div class="accept-popup-close">
                <img src="./images/icon-close-popup.svg" alt="">
              </div>
            </div>
            <div class="accept-popup-body">
              <div class="accept-popup-block empty">
                <div class="accept-popup-files"></div>
                <div class="accept-popup-upload">
                  <input
                    type="file"
                    id="file"
                    class="accept-popup-input"
                    accept=".png, .jpg, .jpeg, .pdf, .doc, .docx, .xls, .xlsx, .webm, .3gp, .mp4, .avi"
                    multiple
                  >
                  <label for="file" class="accept-popup-label">Добавить файлы</label>
                </div>
              </div>
              <div class="accept-popup-text">
                <div class="accept-popup-txt">
                  Размер файла не должен превышать
                  <span>5 мегабайт (Mb)</span>
                </div>
                <div class="accept-popup-txt">
                  Разрешается загружать файлы в форматах
                  <span>.png, jpg, .pdf, .doc, .docx, .xls, .xlsx</span>
                </div>
              </div>
            </div>
            <div class="accept-popup-bottom empty">
              <button class="ui-btn save">Сохранить</button>
              <button class="ui-btn grey close">Отменить изменения</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!--#include file="inc-footer.html"-->
